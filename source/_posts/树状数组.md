---
title: æ ‘çŠ¶æ•°ç»„çš„åŸºæœ¬è¿ç”¨
excerpt: æ ‘çŠ¶æ•°ç»„çš„è¯¦ç»†å­¦ä¹ è¿‡ç¨‹
tags: æ ‘çŠ¶æ•°ç»„
categories: ç®—æ³•å­¦ä¹ 
quicklink: true
---

# æ ‘çŠ¶æ•°ç»„

## å•ç‚¹ä¿®æ”¹ï¼ŒåŒºé—´æŸ¥è¯¢

å­¦ä¹ è¿™ä¸ªç®—æ³•ä¹‹å‰ï¼Œå…ˆæ¥çœ‹ä¸€ä¸ªæ¨¡å‹ï¼š

ç»™å®šä¸€ä¸ªæ•°ç»„arr(0 <= arr.length < 10^5 )ï¼Œç»™ä½ wæ¬¡ä¿®æ”¹ï¼Œä¿®æ”¹æ˜¯ä¿®æ”¹å•ä¸ªç‚¹çš„å€¼ï¼Œqæ¬¡æŸ¥è¯¢ï¼Œæ¯æ¬¡æŸ¥è¯¢éƒ½æ˜¯æŸ¥è¯¢ä»iåˆ°jçš„åŒºé—´å’Œ

- æ¯æ¬¡ä¿®æ”¹æ˜¯O(1),å¯æ˜¯æŸ¥è¯¢èµ·æ¥å°±æ˜¯O(n)äº†

- å¦‚æœç”¨å‰ç¼€å’Œå»ä¼˜åŒ–ï¼Œç¡®å®å®ç°äº†æŸ¥è¯¢æ—¶O(1),å¯æ˜¯è¿™æ ·ä¿®æ”¹å°±å¾—èŠ±è´¹O(n)å»æ›´æ–°å‰ç¼€å’Œæ•°ç»„

é‚£æœ‰æ²¡æœ‰ä¿®æ”¹å’ŒæŸ¥è¯¢éƒ½ç›¸å¯¹è¾ƒå¿«çš„ç®—æ³•å‘¢?

æœ‰ï¼å®ƒå°±æ˜¯æ ‘çŠ¶æ•°ç»„ï¼Œæ²¡é”™ï¼Œä»–å°±æ˜¯å¯ä»¥å®ç°<mark>å•ç‚¹ä¿®æ”¹ï¼ŒåŒºé—´æŸ¥è¯¢</mark>éƒ½åœ¨O(logn)çš„ä¼˜ç§€ç®—æ³•

å…ˆç»™å‡ºæ¨¡æ¿ï¼Œæˆ‘æ˜¯å…ˆå­¦ä¼šç”¨è½®å­ï¼Œå†ææ˜ç™½æ€ä¹ˆé€ è®ºå­çš„ï¼Œä½†æ˜¯ä¹Ÿå¾—å…ˆåŸºæœ¬äº†è§£ä¸€ä¸‹è¿™ä¸ªç®—æ³•çš„æ€æƒ³ï¼Œå»ºè®®çœ‹[äº”åˆ†é’Ÿä¸æ»‘åŠ¨ç”»è®²è§£ | æ ‘çŠ¶æ•°ç»„_å“”å“©å“”å“©_bilibili](https://www.bilibili.com/video/BV1ce411u7qP/?spm_id_from=333.337.search-card.all.click&vd_source=747aad0ef9d3abbace5c886ae7f11192)è¶…çº§å¥½ç†è§£

python

```python
class BIT:
    def __init__(self, n):
        self.tree = [0] * (n + 1)
    def lowbit(self, x):
        return x & (-x)
    def add(self, index, val):
        while index <= len(self.tree) - 1:
            self.tree[index] += val
            index += self.lowbit(index)
    def getsum(self, x):
        ans = 0 
        while x > 0:
            ans += self.tree[x]
            x -= self.lowbit(x)
        return ans
```

java

```java
class BIT{
    private int[] tree;
    public BIT(int n){
        this.tree = new int[n + 1];
    }
    private int lowbit(int x){
        return x & (-x);
    }
    public void add(int index, int val){
        while (index <= tree.length -1){
            tree[index] += val;
            index += lowbit(index);
        }
    }
    public int getsum(int x){
        int ans = 0;
        while (x > 0){
            ans += tree[x];
            x -= lowbit(x);
        }
        return ans;
    }
}
```

c++

```cpp
class BIT{
    private:
        vector<int> tree;
    public:
        BIT(int n): tree(n + 1){}
        inline int lowbit(int x){return x & (-x);}
        inline void add(int index,int val){
            while (index <= tree.size() -1){
                tree[index] += val;
                index += lowbit(index);
            }
        }
        inline int sum(int x){
            int ans = 0;
            while(x > 0){
                ans += tree[x];
                x -= lowbit(x); 
            }
            return ans;
        }
}; 
```

ä»¥ä¸‹æ˜¯åˆšåˆšå…¥é—¨å­¦ä¹ æ•°ç»„å¯ä»¥åˆ·çš„é¢˜å•

- [307. åŒºåŸŸå’Œæ£€ç´¢ - æ•°ç»„å¯ä¿®æ”¹ - åŠ›æ‰£ï¼ˆLeetCodeï¼‰](https://leetcode.cn/problems/range-sum-query-mutable/description/)

- [P3374 ã€æ¨¡æ¿ã€‘æ ‘çŠ¶æ•°ç»„ 1 - æ´›è°· | è®¡ç®—æœºç§‘å­¦æ•™è‚²æ–°ç”Ÿæ€ (luogu.com.cn)](https://www.luogu.com.cn/problem/P3374#submit)ï¼ˆc++100%ï¼Œpython70% é€šè¿‡æ ·ä¾‹ï¼‰
  
  - c++
    
    ```cpp
    #include<iostream>
    #include <vector>
    #define N 500010
    using namespace std;
    int n,m;
    int nums[N];
    
    class BIT{
        private:
            vector<int> tree;
        public:
            BIT(int n): tree(n + 1){}
            inline int lowbit(int x){return x & (-x);}
            inline void add(int index , int val){
                while (index <= tree.size() - 1){
                    tree[index] += val;
                    index += lowbit(index);
                }
            }
            inline int sum(int x){
                int ans = 0;
                while (x > 0){
                    ans += tree[x];
                    x -= lowbit(x);
                }
                return ans;
            }
    };
    int main(){
        cin >> n >> m; 
        BIT bit(n);
        for(int i = 0; i < n; i++){
            cin >> nums[i];
            bit.add(i + 1, nums[i]);
        }
        for(int i = 0; i < m; i++){
            int a, b, c;
            cin >> a >> b >> c;
            if(a == 1){
                bit.add(b,c);
            }else{
                cout<<bit.sum(c) - bit.sum(b - 1) <<endl;
            }
        }
        return 0;
    }
    ```

- python
  
  ```python
  import sys
  n, m = map(int,sys.stdin.readline().strip().split(" "))
  nums = list(map(int,sys.stdin.readline().strip().split(" ")))
  class BIT:
      def __init__(self,n):
          self.tree = [0] * (n + 1)
      def lowbit(self,x):
          return x & (-x)
      def add(self,index,val):
          while index <= len(self.tree) - 1:
              self.tree[index] += val
              index += self.lowbit(index)
      def sum(self,x):
          ans = 0
          while x > 0:
              ans += self.tree[x]
              x -= self.lowbit(x)
          return ans
  bit = BIT(len(nums))
  for i,x in enumerate(nums):
      bit.add(i+1,x)
  for i in range(m):
      a,b,c = map(int,sys.stdin.readline().strip().split(" "))
      if a == 1:
          bit.add(b,c)
      else:
          print(bit.sum(c)-bit.sum(b-1))
  ```

## æ ‘çŠ¶æ•°ç»„çš„åŒºé—´ä¿®æ”¹ï¼Œå•ç‚¹æŸ¥è¯¢

ä»¥ä¸Šå°±æ˜¯ä¸€äº›åŸºæœ¬çš„ç”¨æ³•ï¼Œä½†è¦æ˜¯åŠ ä¸Šå¦‚æœè¦è¿›è¡Œå°†ä¸€æ®µåŒºé—´éƒ½åŠ ä¸ŠæŸä¸ªæ•°çš„æƒ…å†µå‘¢ï¼Ÿ

egï¼šç»™ä½ ä¸€ä¸ªæ•°ç»„[2,3,1,5,7],ç°åœ¨è¦åœ¨ç¬¬ä¸€ä¸ªæ•°åˆ°ç¬¬4ä¸ªæ•°éƒ½åŠ ä¸Š6ï¼ŒO(n)ä¸€ä¸ªä¸€ä¸ªæ·»åŠ è‚¯å®šæ˜¯å¤ªæ…¢äº†ï¼Œè¿™é‡Œå¯ä»¥ç”¨å·®åˆ†çš„æ€æƒ³æ¥åšï¼Œå·®åˆ†ç®€å•æ¥è¯´å°±æ˜¯ä½ å…ˆå¾—åˆ°ä¸Šé¢é‚£ä¸ªæ•°ç»„çš„å·®åˆ†æ•°ç»„

> åŸæ•°ç»„ A = [2,3,1,5,7]

> å·®åˆ†æ•°ç»„ B = [2,1,-2,4,2]

æ²¡é”™ï¼Œå·®åˆ†æ•°ç»„å°±æ˜¯åŸæ•°ç»„ç›¸é‚»ä¹‹é—´çš„å·®å€¼ï¼Œé¦–å…ƒç´ ä¸ç”¨è®¡ç®—

è¿™æ ·å¾—åˆ°çš„å·®åˆ†æ•°ç»„ä½ ä¼šå‘ç°<mark>å¯¹å®ƒæ±‚å‰ç¼€å’Œå°±æ˜¯åŸæ•°ç»„</mark>ï¼ˆå¯ä»¥æ‰‹åŠ¨å°è¯•ï¼ŒåŠ æ·±ç†è§£ï¼‰ï¼Œå†å›åˆ°é¢˜ç›®ï¼Œé‚£è¦å¦‚ä½•æ¯”O(n)è¿˜ä¼˜ç§€æ‰å¯ä»¥ä½¿åŒºé—´[0,3]é‡Œçš„æ•°éƒ½åŠ ä¸Š6å‘¢ï¼Ÿ

æˆ‘ä»¬ä¼šå‘ç°~~(æ‰ä¸æ˜¯æˆ‘ä»¬å‘ç°çš„æ¬¸ğŸ¤£)~~æ­¤æ—¶åªè¦åœ¨å·®åˆ†æ•°ç»„B[0] += 6, åœ¨B[3+1] -= 6ï¼Œå†å°†è¿™ä¸ªå·®åˆ†æ•°ç»„æ±‚å‰ç¼€å’Œï¼Œå°±å¯ä»¥å¾—åˆ°æ»¡è¶³çš„æ•°ç»„äº†ã€‚è¿™æ ·çš„åšæ³•å®é™…ä¸Šåªè¦O(1)çš„æ—¶é—´å¤æ‚åº¦å°±å¯ä»¥å®Œæˆå®é™…æ„ä¹‰ä¸Šçš„åŒºé—´ä¿®æ”¹ã€‚

> ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœé‡åˆ°æœ‰é¢˜ç›®æ˜¯æ—¢è¦ä½ åšå¤šæ¬¡åŒºé—´ä¿®æ”¹ï¼Œåˆè¦ä½ å•ç‚¹æŸ¥è¯¢ã€‚é‚£è¿™ç§é¢˜ä¹Ÿå¯ä»¥ç”¨æ ‘çŠ¶æ•°ç»„æ¥åšã€‚æ ¸å¿ƒæ€æƒ³æ˜¯ **<mark>ç”¨æ ‘çŠ¶æ•°ç»„ç»´æŠ¤åŸæ•°ç»„çš„å·®åˆ†æ•°ç»„</mark>**,åƒå¦‚æœè¦ä½¿ç¬¬ä¸€ä¸ªæ•°åˆ°ç¬¬ä¸‰ä¸ªæ•°éƒ½åŠ ä¸Š6ï¼š

> Â Â Â Â Â Â Â Â add(1,6)

> Â Â Â Â Â Â Â Â add(4,-6)

è¿™ä¸å°±å’Œåˆšåˆšçš„å·®åˆ†æ•°ç»„çš„ä¾‹å­æ˜¯ä¸€ä¸ªæ„æ€å—ã€‚è‡³äºå•ç‚¹æŸ¥è¯¢ï¼Œæ¯”å¦‚æˆ‘è¦æŸ¥ç¬¬4ä¸ªæ•°æ˜¯å¤šå°‘ï¼Œé‚£å°±ç›´æ¥sum(4)ï¼Œå°±å¯ä»¥å¾—åˆ°ç»“æœäº†ï¼Œå› ä¸ºæ ‘çŠ¶æ•°ç»„çš„sumå‡½æ•°ç”¨æ¥æ±‚å‰ç¼€å’Œï¼Œç„¶åè¿™ä¸ªå·®åˆ†æ•°ç»„æ±‚å‰ç¼€å’Œå°±è‡ªç„¶æ˜¯è¿™ä¸ªæ•°äº†ã€‚

é™„ä¸Šç»ƒä¹ é¢˜

- [P3368 ã€æ¨¡æ¿ã€‘æ ‘çŠ¶æ•°ç»„ 2 - æ´›è°· | è®¡ç®—æœºç§‘å­¦æ•™è‚²æ–°ç”Ÿæ€ (luogu.com.cn)](https://www.luogu.com.cn/problem/P3368)ï¼ˆc++ 100% python 70%ï¼‰
  
  - c++
    
    ```cpp
    #include <iostream>
    #include <vector>
    #define N 500000
    using namespace std;
    
    int n,m;
    int nums[N];
    
    class BIT{
        private:
            vector<int> tree;
        public:
            BIT(int n): tree(n + 1){}
            inline int lowbit(int x){return x & (-x);}
            inline void add(int index,int val){
                while (index <= tree.size() - 1){
                    tree[index] += val;
                    index += lowbit(index);
                }
            }
            inline int sum(int x){
                int ans = 0;
                while (x > 0){
                    ans += tree[x];
                    x -= lowbit(x);
                }
                return ans;
            }
    };
    
    int main(){
        cin >> n >> m;
        for(int i = 0; i < n ; i++){
            cin >> nums[i];
        }
        int d[n];
        d[0] = nums[0];
        for(int i = 1; i < n; i++){
            d[i] = nums[i] - nums[i - 1];
        }
        BIT bit(n);
        for(int i = 0; i < n; i++){
            bit.add(i + 1, d[i]);
        }
        for(int i = 0; i < m; i++){
            int z;
            cin >> z;
            if(z == 1){
                int a, b, c;
                cin >> a >> b >> c;
                bit.add(a, c);
                bit.add(b + 1, -c);
            }else{
                int x;
                cin >> x;
                cout << bit.sum(x) << endl;
            }
        }
        return 0;
    
    }
    ```

- python
  
  ```python
  import sys
  N, M = map(int,sys.stdin.readline().strip().split(" "))
  nums = list(map(int,sys.stdin.readline().strip().split(" ")))
  d = [0] * len(nums)
  d[0] = nums[0]
  for i in range(1,len(nums)):
      d[i] = nums[i] - nums[i - 1]
  class BIT:
      def __init__(self,nums):
          n = len(nums)
          self.tree = [0] * (n + 2)
          for i,x in enumerate(nums):
              self.add(i + 1, x)
  
      def lowbit(self,x):
          return x & (-x)
      def add(self, index, val):
          while index <= len(self.tree) - 1:
              self.tree[index] += val
              index += self.lowbit(index)
      def sum(self,x):
          ans = 0
          while x > 0:
              ans += self.tree[x]
              x -= self.lowbit(x)
          return ans
  bit =BIT(d)
  for i in range(M):
      s = list(map(int, sys.stdin.readline().strip().split(" ")))
      if s[0] == 1:
          a, b, c = s[1], s[2], s[3]
          bit.add(a, c)
          bit.add(b + 1, -c)
      else:
          x = s[1]
          print(bit.sum(x))
  ```

è¿˜æ˜¯å»ºè®®ç”¨c++åˆ·é¢˜å§ ğŸ˜…

## åŒºé—´ä¿®æ”¹ï¼ŒåŒºé—´æŸ¥è¯¢

æˆ‘ä»¬æœ‰åŸæ•°ç»„Aï¼Œå·®åˆ†æ•°ç»„dï¼Œå‰ç¼€å’Œæ•°ç»„S

ä»”ç»†è§‚å¯Ÿï¼Œ~~ä½ ä¼šå‘ç°~~ï¼Œä¹Ÿè§‚å¯Ÿä¸å‡ºæ¥ğŸ˜‘ğŸ˜‘ğŸ˜‘ğŸ˜‘

æ•°ç»„då¯¹äºAå¥½æ¯”æ•°ç»„Aå¯¹äºSï¼Œç»†å“ï¼Œä½ ä¼šå‘ç°æ˜¯è¿™æ ·çš„ã€‚
<img src="/images/2gs.png"> 

æ€ä¹ˆè¯æ˜æˆ‘å°±ä¸è¯´äº†ï¼Œå› ä¸ºè„±ç¦»äº†ä¸»é¢˜,~~å…¶å®ä¸ä¼š~~

æ€»ä¹‹ï¼Œæˆ‘ä»¬åªéœ€è¦ç”¨ä¸¤ä¸ªæ ‘çŠ¶æ•°ç»„T1,T2åˆ†åˆ«å–ç»´æŠ¤ d[i] å’Œ d[i] * iï¼Œç­‰åˆ°è¦æ±‚S<sub>4</sub>çš„æ—¶å€™ï¼Œç›´æ¥å°±æ˜¯

> (4+1)*T1.sum(4) - T2.sum(4) å°±okäº†

é‚£åŒºé—´ä¿®æ”¹æ—¶è¦æ€ä¹ˆç»´æŠ¤ï¼Œæ¯”å¦‚è¿™é‡Œç»™ç¬¬2ä¸ªæ•°åˆ°ç¬¬4ä¸ªæ•°éƒ½åŠ ä¸Š6ï¼Œè¦æ€ä¹ˆç»´æŠ¤è¿™ä¸¤é¢—æ ‘ï¼Œå…¶å®æ–¹æ³•å’Œå‰é¢ä¸€æ ·ï¼Œç»´æŠ¤d[i]çš„å‰é¢å·²ç»è¯´äº†ï¼Œd[i]*içš„ä¹Ÿæ˜¯ä¸€æ ·çš„

> T1.add(2,6) T1.add(5,-6)

> T2.add(2,2*6)    T2.add(5,-5 * 6)

è¿™æ ·å°±ç»´æŠ¤å¥½äº†ï¼Œåªè¦çœ‹æ‡‚é‚£å¼ å›¾ï¼Œ~~å…¶å®éƒ½ä¸éš¾~~

- æ¿å­é¢˜[P3372 ã€æ¨¡æ¿ã€‘çº¿æ®µæ ‘ 1 - æ´›è°· | è®¡ç®—æœºç§‘å­¦æ•™è‚²æ–°ç”Ÿæ€ (luogu.com.cn)](https://www.luogu.com.cn/problem/P3372)
  
  - python(70% 3geTLE),çœŸçš„ä¼šæ™•ğŸ˜µ
    
    ```python
    import sys
    class BIT:
        def __init__(self, n):
            self.tree = [0] * (n + 1)
        def lowbit(self, x):
            return x & (-x)
        def add(self,index,val):
            while index <= len(self.tree) - 1:
                self.tree[index] += val
                index += self.lowbit(index)
        def sum(self, x):
            ans = 0
            while x > 0:
                ans += self.tree[x]
                x -= self.lowbit(x)
            return ans
    n, m = map(int,sys.stdin.readline().strip().split())
    nums =  list(map(int,sys.stdin.readline().strip().split()))
    d = [0] * (len(nums))
    d[0] = nums[0]
    for i in range(1,n):
        d[i] = nums[i] - nums[i - 1]
    T1 = BIT(n)
    T2 = BIT(n)
    a = d[0]
    for i in range(len(d)):
        T1.add(i + 1, d[i])
        T2.add(i + 1, d[i] * i)
    
    for i in range(m):
        s = list(map(int,sys.stdin.readline().strip().split()))
        if s[0] == 1:
            x, y, k = s[1], s[2], s[3]
            T1.add(x, k)
            T1.add(y + 1, -k)
            T2.add(x, (x - 1) * k)
            T2.add(y + 1, -y * k)
        else:
            x, y = s[1], s[2]
            l = (x - 1) * T1.sum(x - 1) - T2.sum(x - 1)
            r = y * T1.sum(y) - T2.sum(y)
            print(r-l)
    ```
  
  - c++ (100% è®°å¾—vectoré‡Œå¾—å¡«longï¼Œå¦åˆ™WA3ä¸ª)
    
    ```cpp
    #include <iostream>
    #include <vector>
    #define N 100010
    typedef long long ll;
    using namespace std;
    int n,m,opt,x,y,z,a,b;
    int nums[N];
    class BIT{
        private:
            vector<long>tree;
        public:
            BIT(int n): tree(n + 1){}
            inline int lowbit(int x){return x & (-x);}
            inline void add(int index, int val){
                while (index <= tree.size() - 1){
                    tree[index] += val;
                    index += lowbit(index);
                }
            }
            inline ll sum(int x){
                ll ans = 0;
                while (x > 0){
                    ans += tree[x];
                    x -= lowbit(x);
                }
                return  ans;
            }
    };
    
    int main()
    {
        cin >> n >> m;
        for(int i = 0; i < n; i++){
            cin >> nums[i];
        }
        int d[n];
        d[0] = nums[0];
        for(int i = 1; i < n; i++){
            d[i] = nums[i] - nums[i - 1];
        }
        BIT T1(n);
        BIT T2(n);
        for(int i = 0; i < n; i++){
            T1.add(i + 1, d[i]);
            T2.add(i + 1, d[i] * i);
        }
        for(int i = 0; i < m; i++){
            cin >> opt;
            if(opt == 1){
                cin >> x >> y >> z;
                T1.add(x, z);
                T1.add(y + 1, -z);
                T2.add(x, (x - 1) * z);
                T2.add(y + 1, -y * z);
            }else{
                cin >> a >> b;
                long l = (a - 1) * T1.sum(a - 1) - T2.sum(a - 1);
                long r =  b * T1.sum(b) - T2.sum(b);
                cout << r - l << endl; 
            }
        }
        return 0;
    }
    ```

> æ€»ç»“ä¸€ä¸‹ï¼Œä¹‹å‰å°±å†™è¿‡æ ‘çŠ¶æ•°ç»„ï¼Œè§‰å¾—å®ƒå°±é‚£ä¹ˆä¸€ä¸¤ä¸ªåŠŸèƒ½ï¼Œè„‘å­é‡Œå°±åªè®°å¾—æœ€ç®€å•çš„é‚£ä¸ªæ¿å­ï¼Œç›´åˆ°å‰å‡ å¤©è¢«æ ‘çŠ¶æ•°ç»„è¡€è™ï¼Œæ‰å‘ç°æ ‘çŠ¶æ•°ç»„çœŸçš„å¾ˆå¦™ã€‚è¿™ä¸‰ä¸ªåªæ˜¯ç®—æ¯”è¾ƒå…¥é—¨(è¿›é˜¶)çš„æ“ä½œã€‚å•ç‚¹ä¿®æ”¹ï¼ŒåŒºé—´æŸ¥è¯¢ï¼›åŒºé—´ä¿®æ”¹ï¼Œå•ç‚¹æŸ¥è¯¢ï¼›åŒºé—´ä¿®æ”¹ï¼ŒåŒºé—´æŸ¥è¯¢ã€‚è‡³æ­¤ï¼Œæ ‘çŠ¶æ•°ç»„çš„ä¸€äº›åŸºæœ¬åº”ç”¨å°±åœ¨è¿™é‡Œäº†

Â Â Â Â 
